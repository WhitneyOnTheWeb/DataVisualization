<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="author" content="Whitney King">
    <title>P6: Data Visualization - Whitney King</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>   <!--Import jQuery-->
    <script src="http://d3js.org/d3.v4.min.js"></script>                    <!--Import d3.js-->
    <script src="http://dimplejs.org/dist/dimple.v2.3.0.min.js"></script>   <!--Import dimple.js-->
    <script src="http://colorbrewer2.org/export/colorbrewer.js"></script>  <!--Import D3 ColorBrewer-->
    <script src="https://d3js.org/d3-array.v1.min.js"></script> <!--Import D3 Array-->
    <script type="text/javascript" src="js/d3-tip.js"></script> <!--Import D3 Tip - https://github.com/VACLab/d3-tip/blob/master/d3-tip.js-->
    <script type="text/javascript" src="js/wk_script.js"></script>             <!--Import JavaScript file-->
    <link href="https://fonts.googleapis.com/css?family=Maven+Pro|Open+Sans|Open+Sans+Condensed:300|Patrick+Hand+SC|Roboto+Condensed|Roboto+Slab" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/style.css" />              <!--Import CSS file-->

    <script type="text/javascript">
        // Chart setup
        // D3 Chart: Draw function
        var formatYear = d3.timeFormat("%Y");

        function draw(data) {
            "use strict";

            // Sizing and Position Variables
            var margin = 75,
                width = 1000 - margin,
                height = 600 - margin;

            var radius = 3,
                multiplier = 2;

            var colorsConsole = {'Atari' : '#AC5005',
                                 'Microsoft' : '#AF0553',
                                 'Nintendo' : '#7004B2',
                                 'Other' : '#0337B5',
                                 'PC' : '#02B892',
                                 'Sega' : '#17BB01',
                                 'Sony' : '#BFB700'}

            // Create list of companies
            var companies = [];
            
            for (var c in colorsConsole) {
                if (c.key in companies) {
                    continue;
                }
                else {
                    companies.push(c);
                }
            };

            // Add random jitter to scatterplot
            var epsilon = 15,
                jitter = Math.random() * (2 * epsilon) - epsilon;

            // Create dictionary of data
            function select_game(data) {
                return data.map(function (d) {
                    return {
                        'Rank' : d.Rank,
                        'Name' : d.Name,
                        'Platform' : d.Platform,
                        'Year' : +d.Year,
                        'Genre' : d.Genre,
                        'Publisher' : d.Publisher,
                        'NA_Sales' : d.NA_Sales,
                        'EU_Sales' : d.EU_Sales,
                        'JP_Sales' : d.JP_Sales,
                        'Other_Sales' : d.Other_Sales,
                        'Global_Sales' : d.Global_Sales,
                        'Franchise' : d.Franchise,
                        'Console_Company' : d.Console_Company
                    }
                })
            };
            
            // Save scrubbed data
            var dataDict = select_game(data);

            // Average and sort yearly global sales by platform
            var nestCompany = d3.nest()
                .key(function(d) {
                    return d.Console_Company;
                })
                .sortKeys(d3.ascending).key(function(d) {
                    return d.Year;
                })
                .sortKeys(d3.ascending).rollup(function (d) {
                    return d3.mean(d, function(e) {
                        return e.Global_Sales;
                    });
                })
                .entries(dataDict);

            function update(company) {
                var selected_company = nested.filter(function(d) {
                    return +d.key === company;
                });
            };

            d3.select('body') // Add page title
                .append('h2')
                .text('VGChartz: Top 10,000 Best Selling Video Games Globally');

            d3.select('body') // Add description of data visualization
                .append('p')
                .text('This chart uses global units sales data provided by VGChartz to visualize the popularity of video game consoles year over year by units sold.')

            d3.select('body') // Add factoids about insights that can be expected from the data visualization
                .append('ul')
                    .append('li')
                        .text('Y-Axis is shown in logarithmic scale due to the extremely wide range in values for number of units sold')
                    .append('li')
                        .text('X-Axis only shows games from 1980 - 2016, which were years with complete data')
                    .append('li')
                        .text('Lorem Ipsum')
                    .append('li')
                        .text('Lorem Ipsum')

            d3.select('body') // Add chart title
                .append('h3')
                .text('Console Company (Units Shipped) by Year')

            var tip = d3.tip()
                .attr('class', 'd3-tip')
                .offset([-10, 0])
                .html(function(d) { // Add table to tooltip with detailed information about each data point
                    return "<table class='tooltip'><tr><td>Game:</td><td class='tipName tipInfo'>" + d.Name + "</td></tr>" +
                           "<tr><td>Franchise:</td><td class='tipFranchise tipInfo'>" + d.Franchise + "</td></tr>" +
                           "<tr><td>Publisher:</td><td class='tipPublisher tipInfo'>" + d.Publisher + "</td></tr>" +
                           "<tr><td>Platform:</td><td class='tipPlatform tipInfo'>" + d.Platform + "</td></tr>" +
                           "<tr><td>Console Company:</td><td class='tipCompany tipInfo'>" + d.Console_Company + "</td></tr>" +
                           "<tr><td>Genre:</td><td class='tipGenre tipInfo'>" + d.Genre + "</td></tr>" +
                           "<tr><td>Year:</td><td class='tipYear tipInfo'>" + d.Year + "</td></tr></br>" +
                           "<tr><td>Global Sales:</td><td class='tipGlobalSales tipInfo'>" + d.Global_Sales + "</td></tr>" +
                           "<tr><td>NA Sales:</td><td class='tipNASales tipInfo'>" + d.NA_Sales + "</td></tr>" +
                           "<tr><td>EU Sales:</td><td class='tipEUSales tipInfo'>" + d.EU_Sales + "</td></tr>" +
                           "<tr><td>JP Sales:</td><td class='tipJPSales tipInfo'>" + d.JP_Sales + "</td></tr>" +
                           "<tr><td>Other Sales:</td><td class='tipOtherSales tipInfo'>" + d.Other_Sales + "</td></tr></table>";
                });

            var svg = d3.select('body') // Frame chart area
                .append('svg')
                    .attr('width', width + margin + 200)
                    .attr('height', height + margin)
                .append('g')
                    .attr('class', 'chart');

            svg.call(tip);

            svg.append("rect")
                .attr('class', 'chart-background')
                .attr("width", width - margin + 4)
                .attr("height", height - (margin - 25))
                .attr('left', margin)
                .attr("fill", "whitesmoke")
                .attr("transform", "translate(" + margin + "," + (margin - 25) + ")");

            // Draw data points
            d3.select('svg')
                .selectAll('circle')
                .data(data)
                    .enter()
                .append('circle')
                    .attr('class', function(d) {
                            return 'datapoint' 
                                 + ' company-' + d.Console_Company
                                 + ' rank-' + d.Rank;
                        })
                    .on('mouseover', tip.show)
                    .on('mouseout', tip.hide);

            // Create X-Axis (Time)
            var time_extent = d3.extent(data, function (d) {
                    return d.Year;
                });

            var time_scale = d3.scaleTime()
                .range([margin, width])
                .domain(time_extent);

            var time_axis = d3.axisBottom()
                .scale(time_scale)
                .ticks(20)
                .tickFormat(function(d) {
                    return +d; // Convert tick labels to years
                });

            // Create Y-Axis (Measure)
            var count_extent = d3.extent(data, function (d) {
                    return d.Global_Sales;
                });

            var count_scale = d3.scaleLog()
                .base(Math.E)
                .range([height, 50])
                .domain(count_extent);

            var count_axis = d3.axisLeft()
                .scale(count_scale)
                .ticks(10, d3.format('d'));

            // Draw X-Axis
            d3.select('svg')
                .append('g')
                    .attr('class', 'xaxis')
                    .attr('transform', 'translate(0,' + height + ')')
                .call(time_axis);

            //Draw X-Axis Label
            d3.select('svg')
                .append("text")             
                    .attr("x", (width / 2) + (margin / 2))
                    .attr("y",  height + (margin / 1.5))
                    .attr('class', 'xlabel')
                    .style("text-anchor", "middle")
                    .text("Year");

            //Draw Y-Axis
            d3.select('svg')
                .append('g')
                    .attr('class', 'yaxis')
                    .attr('transform', 'translate('+ margin + ',0)')
                .call(count_axis);

            //Draw Y-Axis Label
            d3.select('svg')
                .append("text")
                    .attr("transform", "rotate(-90)")             
                    .attr("x", 0 - (height / 2) - (margin / 3))
                    .attr("y",  margin / 3.5)
                    .attr("dy", "1em")
                    .attr('class', 'ylabel')
                    .style("text-anchor", "middle")
                    .text("Global Units Sold (millions)");

            // Position and style datapoints
            d3.selectAll('.datapoint')
                .attr('cx', function (d) {
                    return time_scale(d.Year) + d.Jitter;
                })
                .attr('cy', function (d) {
                    return count_scale(d.Global_Sales)
                })
                .attr('r', radius)
                .style('stroke', '0px')
                .attr('fill', function(d) { // Fill each circle with a color depending on Platform name
                    for (var color in colorsConsole) {
                        var match = false;
                        if (d.Console_Company == color) {
                            match = true;
                            return colorsConsole[color];
                        }
                        if (match) { break; }
                    }
                });
            
            /****************************************************************************/
            //BASE OF MARTINI GLASS - shows average sales per platform for each given year
            /****************************************************************************/
            // Draw mean lines
            d3.select('svg')
                .selectAll('path')
                .data(nestCompany, function(d, i) { return d + i; }) // Add index so path is created for each plaform
                    .enter()
                .append('path')
                    .attr('class', function(d) {
                        return 'line company-' + d.key.replace(' ', '-');
                    });

            // Position and style mean lines for each platform
            var lineFunction = d3.line()
                .curve(d3.curveBasis)
                .x(function(d) {
                    return time_scale(d.key);
                })
                .y(function(d) {
                    return count_scale(d.value);
                });

            d3.selectAll('.line')
                .attr('d', function(d) {
                    return lineFunction(d.values);
                })
                .style('stroke', function(d) { // Fill each circle with a color depending on Platform name
                    for (var c in colorsConsole) {
                        var match = false;
                        if (d.key == c) {
                            match = true;
                            return colorsConsole[c];
                        }
                        if (match) { break; }
                    }
                });

            /****************************************************************************/
            //STEM OF MARTINI GLASS - animation with mouse movement to show average units shipped per platform
            //each year. The average will move with the line as the user moves their mouse.
            /****************************************************************************/

            // Show platform sales for each mean line when hovering on chart
            //Reference:  https://bl.ocks.org/larsenmtl/e3b8b7c2ca4787f77d78f58d41c3da91

            //var mouse_scale = d3.scaleTime()
            //    .range([0, width - margin])
            //    .domain(time_extent);

            var mouseElement = svg.append('g')
                                   .attr('class', 'mouse-over-effects');

            mouseElement.append('path')  // Create vertical line to follow the mouse
                .attr('class', 'mouse-line')
                .attr('height', height - margin)
                .style('stroke', 'darkgrey')
                .attr("transform", "translate(" + margin + "," + (margin - 25) + ")")
                .style('stroke-width', '1px')
                .style('opacity', '0');

            var lines = document.getElementsByClassName('line');

            var mousePerLine = mouseElement.selectAll('.mouse-per-line')
                .data(nestCompany, function(d, i) { return d + i; })
                    .enter()
                .append('g')
                    .attr('class', 'mouse-per-line');

            mousePerLine.append("circle")
                .attr("r", 7)
                .style('stroke', function(d) { // Fill each circle with a color depending on Platform name
                    for (var c in colorsConsole) {
                        var match = false;
                        if (d.key == c) {
                            match = true;
                            return colorsConsole[c];
                        }
                        if (match) { break; }
                    }
                })
                .style("fill", "none")
                .style("stroke-width", "3px")
                .style("opacity", "0")
                .attr('z-index', 9999999)
                .attr("transform", "translate(" + margin + ",0)");

            mousePerLine.append('text')
                .attr("transform", "rotate(-45) translate(65, 57)") ;

            mouseElement.append('svg:rect') // append a rect to catch mouse movements on canvas
                .attr("width", width - margin)
				.attr("transform", "translate(" + margin + "," + (margin - 25) + ")")
                .attr("height", height - 50)
                .attr('fill', 'none')
                .attr('pointer-events', 'all')
                .on('mouseout', function() { // on mouse out hide line, circles and text
                    d3.select(".mouse-line")
                    .style("opacity", "0");
                    d3.selectAll(".mouse-per-line circle")
                    .style("opacity", "0");
                    d3.selectAll(".mouse-per-line text")
                    .style("opacity", "0");
                })
                .on('mouseover', function() { // on mouse in show line, circles and text
                    d3.select(".mouse-line")
                        .style("opacity", "1");
                    d3.selectAll(".mouse-per-line circle")
                        .style("opacity", "1");
                    d3.selectAll(".mouse-per-line text")
                        .style("opacity", "1");
                })
                .on('mousemove', function() { // mouse moving over canvas
                    var mouse = d3.mouse(this);
                    d3.select(".mouse-line")
                        .attr("d", function() {
                            var d = "M" + mouse[0] + "," + (height - 50);
                            d += " " + mouse[0] + "," + 0;
                            return d;
                        });

                    d3.selectAll(".mouse-per-line circle")
                        .style("opacity", function (d) {
                                var xYear = +time_scale.invert(mouse[0]) + 3;
                                if (d.key == '2600') {
                                    console.log(d.key + " MouseYear: " + xYear)
                                    console.log('[' + d.values[0].key + ', ' + d.values[d.values.length - 1].key + ']')
                                }
                                if (xYear >= d.values[0].key && xYear < d.values[d.values.length - 1].key) {
                                    return "1";
                                }
                                else {
                                    return "0";
                                };
                            });

                    d3.selectAll(".mouse-per-line text")
                            .style("opacity",  function (d) {
                                var xYear = +time_scale.invert(mouse[0]) + 3;
                                if (xYear >= d.values[0].key && xYear < d.values[d.values.length - 1].key) {
                                    return "1";
                                }
                                else {
                                    return "0";
                                };
                            });

                    d3.selectAll(".mouse-per-line")
                        .attr("transform", function(d, i) {
                                var xYear = +time_scale.invert(mouse[0]) + 3,
                                    bisect = d3.bisector(function(d) { return d.Year; }).right,
                                    idx = bisect(d.values, xYear);
                                var beginning = 0,
                                    end = lines[i].getTotalLength(),
                                    target = null;

                                while (true){
                                    target = Math.floor((beginning + end) / 2);
                                    var pos = lines[i].getPointAtLength(target);
                                    if ((target === end || target === beginning) && (pos.x - margin) !== mouse[0]) {
                                        break;
                                    }
                                    if ((pos.x - margin) > mouse[0])      end = target;
                                    else if ((pos.x - margin) < mouse[0]) beginning = target;
                                    else break; //position found
                                }
                                    
                                var yCount = count_scale.invert(pos.y).toFixed(2);
                                //debugger;
                                d3.select(this).select('text')
                                    .attr('class', d.key + '-text')
                                    .style('z-index', 9999999)
                                    .style('position', 'absolute')
                                    .text(d.key + ":  " + yCount + "m");
                                    
                                return "translate(" + mouse[0] + "," + pos.y +")";
                            });
                });

            // Draw legend
            var legend = svg.append("g")
                .attr("class", "legend")
                .attr("transform", "translate(" + (width + 50) + "," + 20 + ")")
                .selectAll("g")
                .data(companies)
                .enter()
                .append("g");

            // Add colored icons to legend
            legend.append("circle")
                .attr("cy", function(d, i) {
                    return i * 18;
                })
                .attr("r", 4)
                .attr('class', 'legendCircle')
                .attr("fill", function(d) { // Fill each circle with a color depending on Platform name
                    for (var color in colorsConsole) {
                        var match = false;
                        if (d == color) {
                            match = true;
                            return colorsConsole[color];
                        }
                        if (match) { break; }
                    }
                });

            // Add text labels to legend
            legend.append("text")
                .attr('class', 'legendLabel')
                .attr("y", function(d, i) {
                    return i * 18 + 5;
                })
                .attr("x", radius * 5)
                .text(function(d) {
                    return d;
            });
        };
    </script>
</head>

<body>
    <script type="text/javascript">
        /*
        Use D3 to load the CSV file
        and pass the contents of it to the draw function
        */
        
        d3.csv("data/vgsales_clean.csv", function (d) {
            var epsilon = 15,
                jitter = Math.random() * (2 * epsilon) - epsilon; // Add random jitter to scatterplot

            d.Rank = +d.Rank;
            d.Year = +d.Year; // Convert Year to DateTime
            if (!isNaN(d.NA_Sales)) { d.NA_Sales = parseFloat(d.NA_Sales); } // Convert decimals to float values
            if (!isNaN(d.EU_Sales)) { d.EU_Sales = parseFloat(d.EU_Sales); }
            if (!isNaN(d.JP_Sales)) { d.JP_Sales = parseFloat(d.JP_Sales); }
            if (!isNaN(d.Other_Sales)) { d.Other_Sales = parseFloat(d.Other_Sales); }
            if (!isNaN(d.Global_Sales)) { d.Global_Sales = parseFloat(d.Global_Sales); }
            d.Jitter = parseFloat(jitter.toFixed(4)); //Add x-axis jitter value for datapoint
            if ((d.Year == '1980') && (d.Jitter < 0)) {
                d.Jitter = 0;
            }  
            if ((d.Year == '2016') && (d.Jitter > 0)) {
                d.Jitter = 0;
            }
            return d;
        }, draw);
    </script>
</body>

</html>